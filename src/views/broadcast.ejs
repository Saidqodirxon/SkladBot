<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %> - SkladBot Admin</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f0f2f5;
        min-height: 100vh;
      }

      /* Navigation Menu */
      .navbar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .navbar-container {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 30px;
      }

      .navbar-brand {
        font-size: 24px;
        font-weight: bold;
        padding: 20px 0;
      }

      .navbar-menu {
        display: flex;
        list-style: none;
        gap: 5px;
      }

      .navbar-menu a {
        color: white;
        text-decoration: none;
        padding: 20px 20px;
        display: block;
        transition: background 0.3s;
      }

      .navbar-menu a:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .navbar-menu a.active {
        background: rgba(255, 255, 255, 0.2);
        border-bottom: 3px solid white;
      }

      .navbar-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .container {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 30px;
      }

      .page-header {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .page-header h1 {
        font-size: 28px;
        color: #333;
        margin: 0;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s;
      }

      .btn-white {
        background: white;
        color: #667eea;
      }

      .btn-white:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-box {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .stat-box .label {
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
      }

      .stat-box .value {
        font-size: 28px;
        font-weight: bold;
        color: #333;
      }

      .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        margin-bottom: 20px;
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
        font-size: 14px;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-group textarea {
        min-height: 120px;
        resize: vertical;
      }

      .form-help {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .history-list {
        max-height: 600px;
        overflow-y: auto;
      }

      .broadcast-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid;
      }

      .broadcast-item.completed {
        border-color: #28a745;
      }

      .broadcast-item.sending {
        border-color: #ffc107;
      }

      .broadcast-item.failed {
        border-color: #dc3545;
      }

      .broadcast-item.draft {
        border-color: #6c757d;
      }

      .broadcast-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .broadcast-title {
        font-weight: 600;
        color: #333;
      }

      .broadcast-status {
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 600;
      }

      .broadcast-status.completed {
        background: #d4edda;
        color: #155724;
      }

      .broadcast-status.sending {
        background: #fff3cd;
        color: #856404;
      }

      .broadcast-status.failed {
        background: #f8d7da;
        color: #721c24;
      }

      .broadcast-status.draft {
        background: #e2e3e5;
        color: #383d41;
      }

      .broadcast-meta {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .alert {
        padding: 15px 20px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid;
      }

      .alert-warning {
        background: #fff3cd;
        color: #856404;
        border-color: #ffc107;
      }

      @media (max-width: 768px) {
        .content-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation Menu -->
    <nav class="navbar">
      <div class="navbar-container">
        <div class="navbar-brand">ü§ñ SkladBot Admin</div>
        <ul class="navbar-menu">
          <li><a href="/admin/dashboard">üìä Dashboard</a></li>
          <li><a href="/admin/users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a></li>
          <li><a href="/admin/broadcast" class="active">üì¢ –†–∞—Å—Å—ã–ª–∫–∞</a></li>
          <li><a href="/admin/settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
        </ul>
        <div class="navbar-actions">
          <a
            href="/admin/logout"
            class="btn btn-danger"
            style="
              padding: 10px 20px;
              background: #dc3545;
              color: white;
              text-decoration: none;
              border-radius: 5px;
              font-size: 14px;
              font-weight: 600;
            "
            >–í—ã—Ö–æ–¥</a
          >
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="page-header">
        <h1>üì¢ <%= title %></h1>
      </div>

      <div class="stats-row">
        <div class="stat-box">
          <div class="label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
          <div class="value"><%= activeUsers %></div>
        </div>
        <div class="stat-box">
          <div class="label">–î–æ–ª–∂–Ω–∏–∫–æ–≤</div>
          <div class="value"><%= debtorCount %></div>
        </div>
      </div>

      <div class="alert alert-warning">
        ‚ö†Ô∏è <strong>–õ–∏–º–∏—Ç Telegram:</strong> –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–æ 25 —Å–æ–æ–±—â–µ–Ω–∏–π –≤
        —Å–µ–∫—É–Ω–¥—É. –ë–æ–ª—å—à–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –º–æ–≥—É—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è.
      </div>

      <div class="content-grid">
        <!-- Create Broadcast Form -->
        <div class="card">
          <h2>–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</h2>
          <form id="broadcastForm">
            <div class="form-group">
              <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ *</label>
              <input
                type="text"
                id="title"
                name="title"
                required
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–∫—Ü–∏—è –Ω–∞ —Ç–æ–≤–∞—Ä—ã"
              />
            </div>

            <div class="form-group">
              <label for="message_uz">–°–æ–æ–±—â–µ–Ω–∏–µ (–£–∑–±–µ–∫—Å–∫–∏–π) *</label>
              <textarea
                id="message_uz"
                name="message_uz"
                required
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —É–∑–±–µ–∫—Å–∫–æ–º —è–∑—ã–∫–µ"
              ></textarea>
              <div class="form-help">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è emoji –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            </div>

            <div class="form-group">
              <label for="message_ru">–°–æ–æ–±—â–µ–Ω–∏–µ (–†—É—Å—Å–∫–∏–π) *</label>
              <textarea
                id="message_ru"
                name="message_ru"
                required
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ"
              ></textarea>
              <div class="form-help">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è emoji –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            </div>

            <div class="form-group">
              <label for="target_users">–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å *</label>
              <select id="target_users" name="target_users" required>
                <option value="all">
                  –í—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (<%= activeUsers %>)
                </option>
                <option value="debtors">
                  –¢–æ–ª—å–∫–æ –¥–æ–ª–∂–Ω–∏–∫–∞–º (<%= debtorCount %>)
                </option>
              </select>
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-success"
                onclick="sendBroadcast(true)"
              >
                üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="sendBroadcast(false)"
              >
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
              </button>
            </div>
          </form>
        </div>

        <!-- Broadcast History -->
        <div class="card">
          <h2>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫</h2>
          <div class="history-list">
            <% if (broadcasts.length === 0) { %>
            <p style="text-align: center; color: #666; padding: 40px 0">
              üì≠ –†–∞—Å—Å—ã–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç
            </p>
            <% } else { %> <% broadcasts.forEach(broadcast => { %>
            <div class="broadcast-item <%= broadcast.status %>">
              <div class="broadcast-header">
                <div class="broadcast-title"><%= broadcast.title %></div>
                <span class="broadcast-status <%= broadcast.status %>">
                  <%= broadcast.status === 'completed' ? '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' :
                  broadcast.status === 'sending' ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' :
                  broadcast.status === 'failed' ? '–û—à–∏–±–∫–∞' : '–ß–µ—Ä–Ω–æ–≤–∏–∫' %>
                </span>
              </div>
              <div class="broadcast-meta">
                üë§ –ê–≤—Ç–æ—Ä: <%= broadcast.created_by %> | üìÖ <%= new
                Date(broadcast.createdAt).toLocaleString('ru-RU') %> <% if
                (broadcast.status === 'completed') { %> | ‚úÖ <%=
                broadcast.sent_count %>/<%= broadcast.total_count %> –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
                <% } %> <% if (broadcast.status === 'sending') { %> | ‚è≥ <%=
                broadcast.sent_count %>/<%= broadcast.total_count %> <% } %>
              </div>
              <% if (broadcast.status === 'draft') { %>
              <button
                class="btn btn-success"
                style="margin-top: 10px; padding: 5px 15px; font-size: 12px"
                onclick="sendDraft('<%= broadcast._id %>')"
              >
                üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
              </button>
              <% } %>
            </div>
            <% }) %> <% } %>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function sendBroadcast(sendNow) {
        const form = document.getElementById("broadcastForm");
        const formData = new FormData(form);

        const data = {
          title: formData.get("title"),
          message_uz: formData.get("message_uz"),
          message_ru: formData.get("message_ru"),
          target_users: formData.get("target_users"),
          send_now: sendNow,
        };

        if (!data.title || !data.message_uz || !data.message_ru) {
          alert("‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");
          return;
        }

        const confirmMsg = sendNow
          ? `–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É —Å–µ–π—á–∞—Å?\n\n–ü–æ–ª—É—á–∞—Ç–µ–ª–∏: ${
              data.target_users === "all" ? "–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ" : "–¢–æ–ª—å–∫–æ –¥–æ–ª–∂–Ω–∏–∫–∏"
            }`
          : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫?";

        if (!confirm(confirmMsg)) {
          return;
        }

        try {
          const response = await fetch("/admin/broadcast", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            alert("‚úÖ " + result.message);
            window.location.reload();
          } else {
            alert("‚ùå –û—à–∏–±–∫–∞: " + result.error);
          }
        } catch (error) {
          alert("‚ùå –û—à–∏–±–∫–∞: " + error.message);
        }
      }

      async function sendDraft(broadcastId) {
        if (!confirm("–û—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç—É —Ä–∞—Å—Å—ã–ª–∫—É —Å–µ–π—á–∞—Å?")) {
          return;
        }

        try {
          const response = await fetch(`/admin/broadcast/${broadcastId}/send`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });

          const result = await response.json();

          if (result.success) {
            alert("‚úÖ " + result.message);
            window.location.reload();
          } else {
            alert("‚ùå –û—à–∏–±–∫–∞: " + result.error);
          }
        } catch (error) {
          alert("‚ùå –û—à–∏–±–∫–∞: " + error.message);
        }
      }
    </script>
  </body>
</html>
