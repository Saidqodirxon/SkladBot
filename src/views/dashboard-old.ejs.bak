<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - SkladBot Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
        }

        .btn-white {
            background: white;
            color: #667eea;
        }

        .btn-white:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
        }

        .stat-card.purple {
            border-color: #667eea;
        }

        .stat-card.red {
            border-color: #dc3545;
        }

        .stat-card.green {
            border-color: #28a745;
        }

        .stat-card.blue {
            border-color: #17a2b8;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .stat-value.red-text {
            color: #dc3545;
        }

        .stat-value.green-text {
            color: #28a745;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
        }

        .filter-group select {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }

        .debt-amount {
            color: #dc3545;
            font-weight: bold;
        }

        .profit-amount {
            color: #28a745;
            font-weight: bold;
        }

        .cache-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .loading p {
            margin-top: 15px;
            font-size: 16px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä <%= title %></h1>
            <div class="header-actions">
                <a href="/admin/users" class="btn btn-white">üë• –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</a>
                <a href="/admin/broadcast" class="btn btn-white">üì¢ –†–∞—Å—Å—ã–ª–∫–∞</a>
                <a href="/admin/logout" class="btn btn-white">üö™ –í—ã—Ö–æ–¥</a>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card purple">
                <div class="stat-label">üìã –í—Å–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤</div>
                <div class="stat-value"><%= stats.total_counterparties %></div>
            </div>

            <div class="stat-card red">
                <div class="stat-label">‚ö†Ô∏è –î–æ–ª–∂–Ω–∏–∫–æ–≤</div>
                <div class="stat-value"><%= stats.total_debtors %></div>
            </div>

            <div class="stat-card red">
                <div class="stat-label">üí∏ –û–±—â–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</div>
                <div class="stat-value red-text"><%= formatCurrency(stats.total_debt) %></div>
            </div>

            <div class="stat-card green">
                <div class="stat-label">üí∞ –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å (–ø–µ—Ä–µ–ø–ª–∞—Ç—ã)</div>
                <div class="stat-value green-text"><%= formatCurrency(stats.total_profit) %></div>
            </div>

            <div class="stat-card blue">
                <div class="stat-label">üë§ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ –±–æ—Ç–µ</div>
                <div class="stat-value"><%= stats.registered_users %></div>
            </div>

            <div class="stat-card green">
                <div class="stat-label">‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                <div class="stat-value"><%= stats.active_users %></div>
            </div>
        </div>

        <div class="alert alert-info">
            ‚ÑπÔ∏è –ö—ç—à –æ–±–Ω–æ–≤–ª–µ–Ω <%= cacheAge %> –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥. –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å (60 –º–∏–Ω—É—Ç).
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ MoySklad...</p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="filter-group">
                <label for="filter">–§–∏–ª—å—Ç—Ä:</label>
                <select id="filter" onchange="applyFilter()">
                    <option value="all" <%= filter === 'all' ? 'selected' : '' %>>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                    <option value="debtors" <%= filter === 'debtors' ? 'selected' : '' %>>–¢–æ–ª—å–∫–æ –¥–æ–ª–∂–Ω–∏–∫–∏</option>
                    <option value="registered" <%= filter === 'registered' ? 'selected' : '' %>>–¢–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                </select>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                <button class="btn btn-primary" onclick="clearCache()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à</button>
                <button class="btn btn-success" onclick="sendReminders()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–µ–π—á–∞—Å</button>
            </div>
        </div>

        <!-- Users Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–ò–º—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</th>
                        <th>–ë–∞–ª–∞–Ω—Å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ë–æ—Ç</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (counterparties.length === 0) { %>
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            </td>
                        </tr>
                    <% } else { %>
                        <% counterparties.forEach(cp => { %>
                            <tr>
                                <td><%= cp.phone || '–ù–µ —É–∫–∞–∑–∞–Ω' %></td>
                                <td><%= cp.name %></td>
                                <td>
                                    <% if (cp.balance < 0) { %>
                                        <span class="debt-amount"><%= formatCurrency(Math.abs(cp.balance)) %></span>
                                    <% } else if (cp.balance > 0) { %>
                                        <span class="profit-amount">+<%= formatCurrency(cp.balance) %></span>
                                    <% } else { %>
                                        <%= formatCurrency(0) %>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (cp.balance < 0) { %>
                                        <span class="badge badge-danger">–î–æ–ª–∂–Ω–∏–∫</span>
                                    <% } else if (cp.balance > 0) { %>
                                        <span class="badge badge-success">–ü–µ—Ä–µ–ø–ª–∞—Ç–∞</span>
                                    <% } else { %>
                                        <span class="badge badge-secondary">–ù–µ—Ç –¥–æ–ª–≥–∞</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (cp.isRegistered) { %>
                                        <span class="badge <%= cp.userInfo.is_active ? 'badge-success' : 'badge-warning' %>">
                                            <%= cp.userInfo.is_active ? '‚úì –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' : '‚óã –ù–µ–∞–∫—Ç–∏–≤–µ–Ω' %>
                                        </span>
                                    <% } else { %>
                                        <span class="badge badge-secondary">–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</span>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function applyFilter() {
            const filter = document.getElementById('filter').value;
            window.location.href = `/admin/dashboard?filter=${filter}`;
        }

        async function refreshStats() {
            if (!confirm('–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ MoySklad? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.')) {
                return;
            }

            const button = event.target;
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            button.disabled = true;
            button.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            loadingIndicator.style.display = 'block';

            try {
                const response = await fetch('/admin/refresh-stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    window.location.reload();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                loadingIndicator.style.display = 'none';
                button.disabled = false;
                button.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É';
            }
        }

        async function sendReminders() {
            if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?')) {
                return;
            }

            const button = event.target;
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            button.disabled = true;
            button.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
            loadingIndicator.style.display = 'block';

            try {
                const response = await fetch('/admin/send-reminders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ ${result.message}\n\n–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${result.sent}\n–û—à–∏–±–æ–∫: ${result.failed}`);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                loadingIndicator.style.display = 'none';
                button.disabled = false;
                button.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–µ–π—á–∞—Å';
            }
        }

        async function clearCache() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–µ—à? –≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ MoySklad.')) {
                return;
            }

            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';

            try {
                const response = await fetch('/admin/clear-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    location.reload();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>
